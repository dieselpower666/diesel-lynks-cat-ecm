<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#FFC107">
  <meta name="description" content="DieselLynks Caterpillar Tuning AI - Advanced ECM Tuning">
  <title>DieselLynks Caterpillar Tuning AI</title>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icon-512.png">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@300;600&display=swap">
  <style>
    :root {
      --primary: #FFC107;
      --dark: #0a0a0a;
      --white: #ffffff;
      --grey: #888;
      --font-main: 'Orbitron', sans-serif;
      --font-ui: 'Rajdhani', sans-serif;
      --glow: 0 0 8px var(--primary), 0 0 16px rgba(255, 193, 7, 0.4);
      --transition: all 0.3s ease;
    }

    [data-theme="light"] {
      --dark: #ffffff;
      --white: #000000;
      --grey: #666;
      --glow: 0 0 8px var(--primary), 0 0 16px rgba(255, 193, 7, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-ui);
      background: var(--dark);
      color: var(--white);
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      overflow-x: hidden;
    }

    #cinematic-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(180deg, var(--dark), rgba(255, 193, 7, 0.1), var(--dark));
      animation: pulse 4s infinite ease-in-out;
      z-index: -2;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50% { opacity: 0.5; }
    }

    canvas#particle-bg {
      position: fixed;
      top: 0;
      left: 0;
      z-index: -1;
      opacity: 0.8;
      transition: opacity 0.5s ease;
    }

    .fade-in {
      opacity: 0;
      animation: fadeIn 0.5s ease forwards;
    }

    .fade-out {
      opacity: 1;
      animation: fadeOut 0.5s ease forwards;
    }

    @keyframes fadeIn {
      to { opacity: 1; }
    }

    @keyframes fadeOut {
      to { opacity: 0; }
    }

    .glitch {
      position: relative;
      animation: glitch 2s linear infinite;
    }

    .glitch::before,
    .glitch::after {
      content: attr(data-text);
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      color: var(--primary);
      opacity: 0.8;
    }

    .glitch::before {
      animation: glitch-top 1s linear infinite;
      clip-path: polygon(0 0, 100% 0, 100% 33%, 0 33%);
      -webkit-clip-path: polygon(0 0, 100% 0, 100% 33%, 0 33%);
    }

    .glitch::after {
      animation: glitch-bottom 1.5s linear infinite;
      clip-path: polygon(0 67%, 100% 67%, 100% 100%, 0 100%);
      -webkit-clip-path: polygon(0 67%, 100% 67%, 100% 100%, 0 100%);
    }

    @keyframes glitch {
      2%, 64% { transform: translate(2px, 0) skew(0deg); }
      4%, 60% { transform: translate(-2px, 0) skew(0deg); }
      62% { transform: translate(0, 0) skew(5deg); }
    }

    @keyframes glitch-top {
      2%, 64% { transform: translate(2px, -2px); }
      4%, 60% { transform: translate(-2px, 2px); }
      62% { transform: translate(0, 0) skew(5deg); }
    }

    @keyframes glitch-bottom {
      2%, 64% { transform: translate(-2px, 0); }
      4%, 60% { transform: translate(2px, 0); }
      62% { transform: translate(0, 0) skew(-5deg); }
    }

    #opening, #broadcast, #login, #admin-panel {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: var(--dark);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      z-index: 3000;
      opacity: 0;
    }

    #opening.active, #broadcast.active, #login.active, #admin-panel.active {
      opacity: 1;
    }

    #opening.hidden, #broadcast.hidden, #login.hidden, #admin-panel.hidden {
      display: none;
    }

    #opening h1, #broadcast h1 {
      font-family: var(--font-main);
      font-size: clamp(1.5rem, 4vw, 2.5rem);
      color: var(--primary);
      text-shadow: var(--glow);
      text-align: center;
      margin-bottom: 2rem;
    }

    #broadcast p {
      font-family: var(--font-ui);
      font-size: clamp(1rem, 2.5vw, 1.2rem);
      color: var(--white);
      text-shadow: var(--glow);
      text-align: center;
    }

    #loading-bar {
      width: clamp(200px, 50%, 400px);
      height: 4px;
      background: rgba(255, 193, 7, 0.2);
      border-radius: 2px;
      overflow: hidden;
      position: relative;
    }

    #loading-bar::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 0;
      height: 100%;
      background: var(--primary);
      box-shadow: var(--glow);
      animation: load 3s linear forwards;
    }

    @keyframes load {
      0% { width: 0; }
      100% { width: 100%; }
    }

    #login h1, #admin-panel h1 {
      font-family: var(--font-main);
      font-size: clamp(1.8rem, 4vw, 3rem);
      color: var(--primary);
      text-shadow: var(--glow);
      margin-bottom: 1.5rem;
    }

    #login .input-group, #admin-panel .input-group {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      width: clamp(200px, 80%, 400px);
    }

    #login input, #admin-panel input {
      padding: 0.75rem;
      background: transparent;
      color: var(--white);
      border: 2px solid var(--primary);
      border-radius: 6px;
      font-family: var(--font-ui);
      font-size: 1rem;
      transition: var(--transition);
      transform: perspective(500px) translateZ(0);
    }

    #login input:focus, #admin-panel input:focus {
      outline: none;
      box-shadow: var(--glow);
      background: rgba(255, 193, 7, 0.1);
      transform: perspective(500px) translateZ(5px);
    }

    #login button, #admin-panel button {
      padding: 0.75rem;
      font-size: 1rem;
      background: var(--primary);
      border: none;
      color: var(--white);
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-ui);
      font-weight: 600;
      transition: var(--transition);
      transform: perspective(500px) translateZ(0);
    }

    #login button:hover, #admin-panel button:hover {
      transform: perspective(500px) translateZ(5px);
      box-shadow: var(--glow);
      background: linear-gradient(45deg, var(--primary), #FFCA28);
    }

    #login .error, #admin-panel .error {
      margin-top: 1rem;
      color: var(--primary);
      font-size: 0.9rem;
      text-shadow: var(--glow);
      text-align: center;
    }

    #installBanner {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      max-width: 600px;
      margin: auto;
      background: rgba(0, 0, 0, 0.9);
      color: var(--white);
      padding: 1rem;
      text-align: center;
      z-index: 1000;
      display: none;
      box-shadow: 0 -2px 5px rgba(255, 193, 7, 0.2);
      flex-direction: column;
      gap: 0.75rem;
      animation: slideUp 0.5s ease forwards;
    }

    #installBanner.active {
      display: flex;
    }

    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }

    #installBanner p {
      font-family: var(--font-ui);
      font-size: 0.95rem;
      margin: 0;
    }

    #installBanner .button-group {
      display: flex;
      justify-content: center;
      gap: 0.75rem;
    }

    #installBanner button {
      background: var(--primary);
      color: var(--white);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-family: var(--font-ui);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }

    #installBanner button.dismiss {
      background: var(--grey);
    }

    #installBanner button:hover {
      transform: scale(1.05);
      box-shadow: var(--glow);
    }

    header {
      text-align: center;
      padding: 1.5rem 1rem;
      position: relative;
      z-index: 10;
      opacity: 0;
      animation: fadeIn 0.5s ease-in forwards 0.5s;
    }

    header h1 {
      font-family: var(--font-main);
      font-size: clamp(1.8rem, 5vw, 3rem);
      color: var(--primary);
      text-shadow: var(--glow);
    }

    .logo-ascii {
      font-family: monospace;
      font-size: clamp(0.4rem, 1.5vw, 0.6rem);
      color: var(--white);
      white-space: pre;
      margin: 0.5rem auto;
      text-align: center;
      text-shadow: var(--glow);
    }

    .logo-ascii .turbo { color: var(--grey); }
    .logo-ascii .circuit { color: var(--primary); }
    .logo-ascii .text-main { font-family: var(--font-main); font-size: clamp(0.8rem, 2.5vw, 1rem); }
    .logo-ascii .text-sub { font-family: var(--font-main); font-size: clamp(0.6rem, 2vw, 0.8rem); color: var(--primary); }

    .theme-toggle, .logout-button, .admin-button, .audio-toggle {
      position: fixed;
      top: 1rem;
      background: transparent;
      border: 2px solid var(--primary);
      color: var(--white);
      font-size: 1.1rem;
      padding: 0.4rem;
      border-radius: 50%;
      cursor: pointer;
      transition: var(--transition);
    }

    .theme-toggle { right: 1rem; }
    .logout-button { left: 3.5rem; }
    .admin-button { left: 1rem; }
    .audio-toggle { right: 3.5rem; }

    .theme-toggle:hover, .logout-button:hover, .admin-button:hover, .audio-toggle:hover {
      background: var(--primary);
      color: var(--dark);
      transform: rotate(180deg);
      box-shadow: var(--glow);
    }

    .subtitle {
      color: var(--grey);
      font-size: clamp(0.9rem, 2.5vw, 1.2rem);
      margin-top: 0.5rem;
    }

    main {
      max-width: 900px;
      margin: 1rem auto;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid var(--primary);
      border-radius: 8px;
      box-shadow: var(--glow);
      text-align: center;
      z-index: 10;
      opacity: 0;
      animation: slideIn 0.5s ease-in forwards 0.7s;
    }

    main .input-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
      justify-content: center;
    }

    main select {
      width: 100%;
      padding: 0.6rem;
      background: transparent;
      color: var(--white);
      border: 1px solid var(--primary);
      border-radius: 6px;
      font-family: var(--font-ui);
      font-size: 1rem;
      transition: var(--transition);
      transform: perspective(500px) translateZ(0);
    }

    main select {
      appearance: none;
      background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iOCIgdmlld0JveD0iMCAwIDE2IDgiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTEgMS41TDEuNSAwTDggNi41TDE0LjUgMEwxNSAxLjVMOC4yNSA4TDEgMS41WiIgZmlsbD0iI0ZGQzEwNyIvPjwvc3ZnPg==') no-repeat right 0.75rem center/12px 6px;
    }

    main select:focus {
      outline: none;
      box-shadow: var(--glow);
      background: rgba(255, 193, 7, 0.1);
      transform: perspective(500px) translateZ(5px);
    }

    main button {
      padding: 0.75rem 1.5rem;
      font-size: 1rem;
      background: var(--primary);
      border: none;
      color: var(--white);
      border-radius: 6px;
      cursor: pointer;
      font-family: var(--font-ui);
      font-weight: 600;
      transition: var(--transition);
      transform: perspective(500px) translateZ(0);
    }

    main button:hover {
      transform: perspective(500px) translateZ(5px);
      box-shadow: var(--glow);
      background: linear-gradient(45deg, var(--primary), #FFCA28);
    }

    .status {
      margin-top: 1rem;
      font-family: var(--font-ui);
      color: var(--white);
      font-size: 1rem;
      text-shadow: var(--glow);
    }

    .progress-container {
      width: clamp(200px, 50%, 400px);
      height: 6px;
      background: rgba(255, 193, 7, 0.2);
      border-radius: 3px;
      overflow: hidden;
      margin: 0.5rem auto;
    }

    .progress-bar {
      width: 0;
      height: 100%;
      background: var(--primary);
      box-shadow: var(--glow);
      transition: width 0.5s ease;
    }

    .button-group {
      display: flex;
      gap: 1rem;
      justify-content: center;
      margin-top: 1rem;
    }

    #downloadButton, #resetButton {
      display: none;
    }

    #downloadButton.active, #resetButton.active {
      display: inline-block;
    }

    footer {
      text-align: center;
      padding: 1rem;
      color: var(--grey);
      font-size: 0.85rem;
      z-index: 10;
      opacity: 0;
      animation: fadeIn 0.5s ease-in forwards 0.9s;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 600px) {
      #opening h1, #broadcast h1 { font-size: 1.2rem; }
      #broadcast p { font-size: 0.9rem; }
      #login h1, #admin-panel h1 { font-size: 1.6rem; }
      header h1 { font-size: 1.6rem; }
      .logo-ascii { font-size: 0.35rem; }
      .logo-ascii .text-main { font-size: 0.7rem; }
      .logo-ascii .text-sub { font-size: 0.55rem; }
      main { margin: 0.5rem; padding: 1rem; }
      main .input-group { grid-template-columns: 1fr; }
      main select { width: 100%; }
      .subtitle { font-size: 0.85rem; }
      .theme-toggle, .logout-button, .admin-button, .audio-toggle {
        font-size: 1rem;
        padding: 0.35rem;
      }
      .theme-toggle { right: 1rem; }
      .logout-button { left: 1rem; top: 3.5rem; }
      .admin-button { left: 1rem; }
      .audio-toggle { right: 1rem; top: 3.5rem; }
      .button-group { flex-direction: column; }
      #installBanner {
        padding: 0.75rem;
        gap: 0.5rem;
      }
      #installBanner p { font-size: 0.85rem; }
      #installBanner .button-group { flex-direction: column; gap: 0.5rem; }
      #installBanner button { padding: 0.5rem 0.75rem; font-size: 0.85rem; }
      #loading-bar { width: 80%; }
      .progress-container { width: 80%; }
    }
  </style>
</head>
<body>
  <div id="cinematic-bg"></div>
  <canvas id="particle-bg"></canvas>
  <div id="opening" class="hidden">
    <h1 id="opening-title" class="glitch" data-text="Initializing DieselLynks Caterpillar Tuning Protocol...">Initializing DieselLynks Caterpillar Tuning Protocol...</h1>
    <div id="loading-bar"></div>
  </div>
  <div id="broadcast" class="hidden">
    <h1 class="glitch" data-text="Caterpillar Tuning Protocol Initialized">Caterpillar Tuning Protocol Initialized</h1>
    <p>Welcome, Tuners... Please Select Engine Type, Model, and Tuning Options</p>
  </div>
  <div id="login" class="hidden">
    <h1 class="glitch" data-text="DieselLynks Login">DieselLynks Login</h1>
    <div class="input-group">
      <input type="text" id="username" placeholder="Username" autocomplete="off" aria-label="Username" required>
      <input type="password" id="password" placeholder="Password" aria-label="Password" required>
      <button onclick="login()" aria-label="Login to DieselLynks">Login</button>
    </div>
    <p class="error" id="loginError"></p>
  </div>
  <div id="admin-panel" class="hidden">
    <h1 class="glitch" data-text="Admin Panel">Admin Panel</h1>
    <div class="input-group">
      <input type="text" id="newUsername" placeholder="New Username" autocomplete="off" aria-label="New Username" required>
      <input type="password" id="newPassword" placeholder="New Password" aria-label="New Password" required>
      <button onclick="addUser()" aria-label="Add New User">Add User</button>
      <button onclick="backToMain()" aria-label="Back to Main Interface">Back</button>
    </div>
    <p class="error" id="adminError"></p>
  </div>
  <div id="installBanner" role="dialog" aria-labelledby="installMessage">
    <p id="installMessage"></p>
    <div class="button-group">
      <button onclick="installApp()" aria-label="Install DieselLynks App">Install Now</button>
      <button class="dismiss" onclick="dismissInstallBanner()" aria-label="Dismiss Install Banner">Dismiss</button>
    </div>
  </div>
  <header style="display: none;">
    <pre class="logo-ascii" aria-label="DieselLynks ASCII Logo">
<span class="turbo">   _____
  /     \
 /_______\
|  ***  |</span> <span class="circuit">~~~
|  ***  | ~~~
|_______|~~~</span>
<span class="text-main">DIESELLYNKS</span>
<span class="text-sub">CATERPILLAR TUNING AI</span>
    </pre>
    <h1 class="glitch" data-text="DieselLynks Caterpillar Tuning AI">DieselLynks Caterpillar Tuning AI</h1>
    <p class="subtitle">Advanced ECM Tuning for Caterpillar Engines</p>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">🌙</button>
    <button class="logout-button" onclick="logout()" aria-label="Logout">🚪</button>
    <button class="admin-button" id="adminButton" onclick="showAdminPanel()" aria-label="Admin Panel" style="display: none;">⚙️</button>
    <button class="audio-toggle" onclick="toggleAudio()" aria-label="Toggle audio">🔊</button>
  </header>
  <main role="form" style="display: none;">
    <div class="input-group">
      <select id="engineType" aria-label="Engine Type" onchange="updateModelOptions()">
        <option value="" disabled selected>Select Engine Type</option>
        <option value="3406">3406</option>
        <option value="C7">C7</option>
        <option value="C9">C9</option>
        <option value="C10">C10</option>
        <option value="C12">C12</option>
        <option value="C13">C13</option>
        <option value="C15">C15</option>
        <option value="C16">C16</option>
        <option value="C18">C18</option>
      </select>
      <select id="engineModel" aria-label="Engine Model" disabled>
        <option value="" disabled selected>Select Engine Model</option>
      </select>
      <select id="mod" aria-label="Modifications">
        <option value="" disabled selected>Mod: Yes/No</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <select id="hpIncrease" aria-label="HP Increase">
        <option value="" disabled selected>HP Increase: Yes/No</option>
        <option value="Yes">Yes</option>
        <option value="No">No</option>
      </select>
      <button onclick="submitCode()" aria-label="Submit Engine Type, Model, and Tuning Options">Submit</button>
    </div>
    <p class="status" id="status">Awaiting Engine Type, Model, and Tuning Options...</p>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="button-group">
      <button id="downloadButton" onclick="downloadFile()" aria-label="Download Calibration File">Download File</button>
      <button id="resetButton" onclick="resetForm()" aria-label="Reset Form">Reset</button>
    </div>
  </main>
  <footer style="display: none;">
    © 2025 DieselLynks AI Systems | Powered by The Diesel Hub / The Dieselnauts
  </footer>
  <audio id="clickSound" src="/audio/click.mp3" preload="auto"></audio>
  <audio id="introSound" src="/audio/intro.mp3" preload="auto"></audio>
  <script>
    // Engine Model Mapping
    const engineModels = {
      '3406': ['E', 'B', 'C', 'PEEC'],
      'C7': ['WAX', 'SAP', 'KAL', 'YPG', 'C7S'],
      'C9': ['ETK', '9DG', 'CKP', 'LFE', 'C9S'],
      'C10': ['3CS', '2PN', '1YN', '8YS'],
      'C12': ['2KS', '9NS', 'CPD', 'MBL', '8YF'],
      'C13': ['LEE', 'KCB', 'JAM', 'B5R', 'LGK'],
      'C15': ['BXS', 'MXS', 'NXS', 'SDP', '6NZ', '7CZ', 'EGH', 'JEP', 'MBJ'],
      'C16': ['7CZ', '2WS', 'W1A'],
      'C18': ['CJP', 'MEP', 'WJH']
    };

    function updateModelOptions() {
      const engineType = document.getElementById('engineType').value;
      const modelSelect = document.getElementById('engineModel');
      modelSelect.innerHTML = '<option value="" disabled selected>Select Engine Model</option>';
      modelSelect.disabled = !engineType;

      if (engineType && engineModels[engineType]) {
        engineModels[engineType].forEach(model => {
          const option = document.createElement('option');
          option.value = model;
          option.textContent = model;
          modelSelect.appendChild(option);
        });
      }
    }

    // Initialize Users
    function initUsers() {
      if (!localStorage.getItem('dieselLynksUsers')) {
        localStorage.setItem('dieselLynksUsers', JSON.stringify([
          { username: 'admin', password: 'caterpillar2025', role: 'admin' }
        ]));
      }
    }

    // Session Management
    function validateSession() {
      const session = JSON.parse(localStorage.getItem('dieselLynksSession') || '{}');
      if (!session.username) {
        localStorage.removeItem('dieselLynksSession');
        return false;
      }
      const users = JSON.parse(localStorage.getItem('dieselLynksUsers') || '[]');
      const user = users.find(u => u.username.toLowerCase() === session.username.toLowerCase());
      if (!user) {
        localStorage.removeItem('dieselLynksSession');
        return false;
      }
      return true;
    }

    function getCurrentUser() {
      if (!validateSession()) return null;
      const session = JSON.parse(localStorage.getItem('dieselLynksSession'));
      const users = JSON.parse(localStorage.getItem('dieselLynksUsers') || '[]');
      return users.find(user => user.username.toLowerCase() === session.username.toLowerCase()) || null;
    }

    function isLoggedIn() {
      return validateSession();
    }

    // Audio Control
    let audioEnabled = localStorage.getItem('audioEnabled') !== 'false';
    const clickSound = document.getElementById('clickSound');
    const introSound = document.getElementById('introSound');

    function playSound(audio) {
      if (audioEnabled) {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }
    }

    function toggleAudio() {
      audioEnabled = !audioEnabled;
      localStorage.setItem('audioEnabled', audioEnabled);
      document.querySelector('.audio-toggle').textContent = audioEnabled ? '🔊' : '🔇';
    }

    // Cinematic Intro
    function startIntro() {
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');
      header.style.display = 'none';
      main.style.display = 'none';
      footer.style.display = 'none';

      if (sessionStorage.getItem('introShown') === 'true' && isLoggedIn()) {
        showMainInterface();
        return;
      }

      const opening = document.getElementById('opening');
      const broadcast = document.getElementById('broadcast');
      const canvas = document.getElementById('particle-bg');

      opening.classList.remove('active', 'fade-in', 'fade-out', 'hidden');
      broadcast.classList.remove('active', 'fade-in', 'fade-out', 'hidden');

      canvas.style.opacity = '0.4';
      opening.classList.add('active', 'fade-in');
      playSound(introSound);

      setTimeout(() => {
        opening.classList.remove('fade-in');
        opening.classList.add('fade-out');
        setTimeout(() => {
          opening.classList.remove('active', 'fade-out');
          opening.classList.add('hidden');
          broadcast.classList.add('active', 'fade-in');
        }, 500);
      }, 4000);

      setTimeout(() => {
        broadcast.classList.remove('fade-in');
        broadcast.classList.add('fade-out');
        setTimeout(() => {
          broadcast.classList.remove('active', 'fade-out');
          broadcast.classList.add('hidden');
          sessionStorage.setItem('introShown', 'true');
          canvas.style.opacity = '0.8';
          showMainInterface();
        }, 500);
      }, 7000);
    }

    // Show Login Screen
    function showLogin() {
      const login = document.getElementById('login');
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');
      header.style.display = 'none';
      main.style.display = 'none';
      footer.style.display = 'none';
      login.classList.remove('hidden');
      login.classList.add('active', 'fade-in');
    }

    // Login
    function login() {
      playSound(clickSound);
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const error = document.getElementById('loginError');
      const users = JSON.parse(localStorage.getItem('dieselLynksUsers') || '[]');

      if (!username || !password) {
        error.textContent = 'Please enter username and password';
        return;
      }

      const user = users.find(u => u.username.toLowerCase() === username.toLowerCase() && u.password === password);
      if (user) {
        localStorage.setItem('dieselLynksSession', JSON.stringify({ username: user.username }));
        error.textContent = '';
        const login = document.getElementById('login');
        login.classList.remove('fade-in');
        login.classList.add('fade-out');
        setTimeout(() => {
          login.classList.remove('active', 'fade-out');
          login.classList.add('hidden');
          startIntro();
        }, 500);
      } else {
        error.textContent = 'Invalid username or password';
      }
    }

    // Logout
    function logout() {
      playSound(clickSound);
      localStorage.removeItem('dieselLynksSession');
      sessionStorage.removeItem('introShown');
      const login = document.getElementById('login');
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');
      const adminButton = document.getElementById('adminButton');

      header.classList.add('fade-out');
      main.classList.add('fade-out');
      footer.classList.add('fade-out');
      setTimeout(() => {
        adminButton.style.display = 'none';
        header.style.display = 'none';
        main.style.display = 'none';
        footer.style.display = 'none';
        header.classList.remove('fade-out');
        main.classList.remove('fade-out');
        footer.classList.remove('fade-out');
        login.classList.remove('hidden');
        login.classList.add('active', 'fade-in');
      }, 500);
    }

    // Admin Panel
    function addUser() {
      playSound(clickSound);
      const currentUser = getCurrentUser();
      const error = document.getElementById('adminError');
      if (!currentUser || currentUser.role !== 'admin') {
        error.textContent = 'Unauthorized: Admin access required';
        return;
      }

      const newUsername = document.getElementById('newUsername').value.trim();
      const newPassword = document.getElementById('newPassword').value;
      const users = JSON.parse(localStorage.getItem('dieselLynksUsers') || '[]');

      if (!newUsername || !newPassword) {
        error.textContent = 'Please enter a username and password';
        return;
      }

      if (users.find(u => u.username.toLowerCase() === newUsername.toLowerCase())) {
        error.textContent = 'Username already exists';
        return;
      }

      users.push({ username: newUsername, password: newPassword, role: 'user' });
      localStorage.setItem('dieselLynksUsers', JSON.stringify(users));
      error.textContent = `User ${newUsername} added successfully`;
      document.getElementById('newUsername').value = '';
      document.getElementById('newPassword').value = '';
    }

    function showAdminPanel() {
      playSound(clickSound);
      const currentUser = getCurrentUser();
      if (!currentUser || currentUser.role !== 'admin') return;

      const adminPanel = document.getElementById('admin-panel');
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');

      header.classList.add('fade-out');
      main.classList.add('fade-out');
      footer.classList.add('fade-out');
      setTimeout(() => {
        header.style.display = 'none';
        main.style.display = 'none';
        footer.style.display = 'none';
        header.classList.remove('fade-out');
        main.classList.remove('fade-out');
        footer.classList.remove('fade-out');
        adminPanel.classList.remove('hidden');
        adminPanel.classList.add('active', 'fade-in');
        document.getElementById('adminError').textContent = '';
      }, 500);
    }

    function backToMain() {
      playSound(clickSound);
      const adminPanel = document.getElementById('admin-panel');
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');

      adminPanel.classList.add('fade-out');
      setTimeout(() => {
        adminPanel.classList.remove('active', 'fade-out');
        adminPanel.classList.add('hidden');
        header.style.display = 'block';
        main.style.display = 'block';
        footer.style.display = 'block';
        header.classList.add('fade-in');
        main.classList.add('fade-in');
        footer.classList.add('fade-in');
        setTimeout(() => {
          header.classList.remove('fade-in');
          main.classList.remove('fade-in');
          footer.classList.remove('fade-in');
        }, 500);
        document.getElementById('adminError').textContent = '';
      }, 500);
    }

    // Main Interface
    function showMainInterface() {
      const header = document.querySelector('header');
      const main = document.querySelector('main');
      const footer = document.querySelector('footer');
      const adminButton = document.getElementById('adminButton');
      const currentUser = getCurrentUser();

      header.style.display = 'block';
      main.style.display = 'block';
      footer.style.display = 'block';
      header.classList.add('fade-in');
      main.classList.add('fade-in');
      footer.classList.add('fade-in');
      setTimeout(() => {
        header.classList.remove('fade-in');
        main.classList.remove('fade-in');
        footer.classList.remove('fade-in');
      }, 500);
      if (currentUser && currentUser.role === 'admin') {
        adminButton.style.display = 'block';
      }
      showInstallBanner();
    }

    // Theme Toggle
    function toggleTheme() {
      playSound(clickSound);
      const body = document.body;
      const theme = body.dataset.theme === 'dark' ? 'light' : 'dark';
      body.dataset.theme = theme;
      localStorage.setItem('theme', theme);
      document.querySelector('.theme-toggle').textContent = theme === 'dark' ? '🌙' : '🌞';
    }

    function loadTheme() {
      const theme = localStorage.getItem('theme') || 'dark';
      document.body.dataset.theme = theme;
      document.querySelector('.theme-toggle').textContent = theme === 'dark' ? '🌙' : '🌞';
      document.querySelector('.audio-toggle').textContent = audioEnabled ? '🔊' : '🔇';
    }

    // Engine Submission
    let downloadUrl = null;
    let downloadFilename = null;

    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }

    async function submitCode() {
      playSound(clickSound);
      const engineType = document.getElementById('engineType').value;
      const engineModel = document.getElementById('engineModel').value;
      const mod = document.getElementById('mod').value;
      const hpIncreaseOnly = document.getElementById('hpIncreaseOnly').value;
      const status = document.getElementById('status');
      const progressBar = document.getElementById('progressBar');
      const downloadButton = document.getElementById('downloadButton');
      const resetButton = document.getElementById('resetButton');

      if (!engineType || !engineModel || !mod || !hpIncreaseOnly) {
        status.textContent = 'Error: Please select all options (Engine Type, Model, Mod, HP Increase)';
        progressBar.style.width = '0%';
        return;
      }

      // Disable inputs and submit button during processing
      document.getElementById('engineType').disabled = true;
      document.getElementById('engineModel').disabled = true;
      document.getElementById('mod').disabled = true;
      document.getElementById('hpIncreaseOnly').disabled = true;
      document.querySelector('main button[onclick="submitCode()"]').disabled = true;
      downloadButton.classList.remove('active');
      resetButton.classList.remove('active');
      progressBar.style.width = '0%';

      // Clear previous download data
      if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
        downloadFilename = null;
      }

      // Loading sequence
      const loadingMessages = [
        'Connecting to Caterpillar server...',
        'Locating your ECM original cal...',
        'Original cal located...',
        'Securing cal...',
        'Cal secured...',
        'Opening cal...',
        'Modification sequence initiated...',
        'Map pack initiated...',
        'Modifications in progress...',
        'All mods approved and accepted...',
        'Closing cal...',
        'Checksum verification...',
        'Checksum good...',
        'Your cal is ready, awaiting server response...'
      ];

      // Run loading sequence
      async function runLoadingSequence() {
        const totalSteps = loadingMessages.length;
        for (let i = 0; i < totalSteps; i++) {
          status.textContent = loadingMessages[i];
          progressBar.style.width = `${((i + 1) / totalSteps) * 100}%`;
          await delay(2500); // Increased to 2.5 seconds for smoother sequence
        }
      }

      // Webhook request
      const webhookUrl = 'https://alastor-n8n.onrender.com/webhook-test/diesel-lynks-cat-ecm';
      const payload = {
        engine_type: engineType,
        engine_model: engineModel,
        mod: mod,
        hp_increase_only: hpIncreaseOnly
      };

      try {
        // Start loading sequence and webhook request in parallel
        const sequencePromise = runLoadingSequence();
        const response = await fetch(webhookUrl, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        // Wait for sequence to complete
        await sequencePromise;

        // Validate webhook response
        if (response.ok) {
          const contentType = response.headers.get('Content-Type') || '';
          console.log('Webhook Response Headers:', {
            status: response.status,
            contentType: contentType,
            contentDisposition: response.headers.get('Content-Disposition')
          });

          if (!contentType.includes('application/zip') && !contentType.includes('application/octet-stream')) {
            status.textContent = 'Error: Invalid file type received from server';
            progressBar.style.width = '0%';
            resetButton.classList.add('active');
            enableInputs();
            return;
          }

          const blob = await response.blob();
          console.log('Blob Details:', {
            size: blob.size,
            type: blob.type
          });

          if (blob.size > 0 && (blob.type === 'application/zip' || blob.type === 'application/octet-stream')) {
            const contentDisposition = response.headers.get('Content-Disposition');
            downloadFilename = contentDisposition && contentDisposition.includes('filename=')
              ? contentDisposition.split('filename=')[1].replace(/"/g, '')
              : `cat_${engineType}_${engineModel}_mod_${mod}_hp_${hpIncreaseOnly}.zip`;

            downloadUrl = window.URL.createObjectURL(blob);
            status.textContent = 'Calibration file ready! Click Download to retrieve.';
            downloadButton.classList.add('active');
            resetButton.classList.add('active');
          } else {
            status.textContent = 'Error: Empty or invalid file received from server';
            progressBar.style.width = '0%';
            resetButton.classList.add('active');
            enableInputs();
          }
        } else {
          const errorText = await response.text();
          status.textContent = `Error: Failed to retrieve file (Status: ${response.status}, ${errorText})`;
          progressBar.style.width = '0%';
          resetButton.classList.add('active');
          enableInputs();
        }
      } catch (error) {
        await runLoadingSequence();
        status.textContent = `Error: Network issue (${error.message})`;
        progressBar.style.width = '0%';
        resetButton.classList.add('active');
        enableInputs();
      }
    }

    function enableInputs() {
      document.getElementById('engineType').disabled = false;
      document.getElementById('engineModel').disabled = false;
      document.getElementById('mod').disabled = false;
      document.getElementById('hpIncreaseOnly').disabled = false;
      document.querySelector('main button[onclick="submitCode()"]').disabled = false;
    }

    function downloadFile() {
      playSound(clickSound);
      if (downloadUrl && downloadFilename) {
        console.log('Downloading file:', { url: downloadUrl, filename: downloadFilename });
        const link = document.createElement('a');
        link.href = downloadUrl;
        link.download = downloadFilename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        document.getElementById('status').textContent = `File downloaded: ${downloadFilename}. Click Reset to start over.`;
        document.getElementById('progressBar').style.width = '0%';
      } else {
        document.getElementById('status').textContent = 'Error: No valid file available for download';
      }
    }

    function resetForm() {
      playSound(clickSound);
      document.getElementById('engineType').value = '';
      document.getElementById('engineModel').value = '';
      document.getElementById('engineModel').innerHTML = '<option value="" disabled selected>Select Engine Model</option>';
      document.getElementById('engineModel').disabled = true;
      document.getElementById('mod').value = '';
      document.getElementById('hpIncreaseOnly').value = '';
      document.getElementById('status').textContent = 'Awaiting Engine Type, Model, and Tuning Options...';
      document.getElementById('progressBar').style.width = '0%';
      document.getElementById('downloadButton').classList.remove('active');
      document.getElementById('resetButton').classList.remove('active');
      enableInputs();
      if (downloadUrl) {
        window.URL.revokeObjectURL(downloadUrl);
        downloadUrl = null;
        downloadFilename = null;
      }
    }

    // PWA Installation
    let deferredPrompt;
    const installBanner = document.getElementById('installBanner');
    const installMessage = document.getElementById('installMessage');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      if (isLoggedIn()) {
        showInstallBanner();
      }
    });

    function showInstallBanner() {
      if (window.matchMedia('(display-mode: standalone)').matches ||
          localStorage.getItem('installBannerDismissed') === 'true' ||
          localStorage.getItem('appInstalled') === 'true') {
        return;
      }

      const ua = navigator.userAgent.toLowerCase();
      if (/iphone|ipad|ipod/.test(ua)) {
        installMessage.textContent = 'Tap the Share icon and select "Add to Home Screen" to install.';
      } else if (/android/.test(ua)) {
        installMessage.textContent = 'Tap "Install Now" or add to your home screen from the browser menu.';
      } else {
        installMessage.textContent = 'Add DieselLynks to your home screen for quick access.';
      }
      installBanner.classList.add('active');
    }

    function installApp() {
      playSound(clickSound);
      if (!deferredPrompt) {
        installBanner.classList.remove('active');
        return;
      }
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choice) => {
        if (choice.outcome === 'accepted') {
          localStorage.setItem('appInstalled', 'true');
        }
        deferredPrompt = null;
        installBanner.classList.remove('active');
      });
    }

    function dismissInstallBanner() {
      playSound(clickSound);
      localStorage.setItem('installBannerDismissed', 'true');
      installBanner.classList.remove('active');
    }

    // Particle Animation
    const canvas = document.getElementById('particle-bg');
    const ctx = canvas.getContext('2d', { alpha: true });
    let width = canvas.width = window.innerWidth;
    let height = canvas.height = window.innerHeight;
    const particles = [];
    const count = Math.min(80, Math.floor(window.innerWidth / 12));

    class Particle {
      constructor() {
        this.reset();
      }

      reset() {
        this.x = Math.random() * width;
        this.y = Math.random() * height;
        this.size = Math.random() * 1.5 + 1;
        this.speedX = Math.random() * 0.3 - 0.15;
        this.speedY = Math.random() * 0.3 - 0.15;
        this.opacity = Math.random() * 0.3 + 0.2;
        this.glow = Math.random() * 4 + 2;
      }

      update() {
        this.x += this.speedX;
        this.y += this.speedY;
        if (this.x < 0 || this.x > width || this.y < 0 || this.y > height) this.reset();
      }

      draw() {
        ctx.fillStyle = `rgba(255, 193, 7, ${this.opacity * (document.body.dataset.theme === 'light' ? 0.5 : 1)})`;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.shadowBlur = this.glow;
        ctx.shadowColor = 'rgba(255, 193, 7, 0.7)';
        ctx.fill();
        ctx.shadowBlur = 0;
      }
    }

    function initParticles() {
      particles.length = 0;
      for (let i = 0; i < count; i++) particles.push(new Particle());
    }

    function animate() {
      ctx.fillStyle = `rgba(${document.body.dataset.theme === 'light' ? '255, 255, 255' : '0, 0, 0'}, 0.05)`;
      ctx.fillRect(0, 0, width, height);
      particles.forEach(p => { p.update(); p.draw(); });
      requestAnimationFrame(animate);
    }

    initParticles();
    animate();

    window.addEventListener('resize', () => {
      width = canvas.width = window.innerWidth;
      height = canvas.height = window.innerHeight;
      initParticles();
    });

    // Offline Detection
    window.addEventListener('online', () => {
      document.getElementById('status').textContent = 'Back online';
    });

    window.addEventListener('offline', () => {
      document.getElementById('status').textContent = 'Offline mode: Limited functionality';
    });

    // Service Worker
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', async () => {
        try {
          if (window.location.protocol === 'file:') {
            console.error('Service Worker Error: Cannot register from file:// protocol.');
            return;
          }
          const response = await fetch('/sw.js', { method: 'HEAD' });
          if (!response.ok) {
            console.error(`Service Worker Error: Failed to access sw.js (status: ${response.status})`);
            return;
          }
          const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
          console.log('Service Worker registered:', registration);
        } catch (err) {
          console.error('Service Worker Error:', err.message || err);
        }
      });
    }

    // Initialize
    window.addEventListener('load', () => {
      initUsers();
      loadTheme();
      if (isLoggedIn()) {
        startIntro();
      } else {
        showLogin();
      }
    });
  </script>
</body>
</html>
